<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hextorio Item Value Explorer (HIVE)</title>
<script src="https://unpkg.com/pako@2.1.0/dist/pako.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
    color: #e0e0e0;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

#header {
    display: flex;
    align-items: center;
    padding: 8px 16px;
    background: #151515;
    border-bottom: 1px solid #3a3a3a;
    gap: 12px;
    flex-shrink: 0;
}
#header h1 {
    font-size: 16px;
    background: linear-gradient(135deg, #D4AF37, #B8860B);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    white-space: nowrap;
}

#toolbar {
    display: flex;
    align-items: center;
    padding: 6px 16px;
    background: #111;
    border-bottom: 1px solid #3a3a3a;
    gap: 16px;
    flex-shrink: 0;
    font-size: 12px;
}
.toolbar-group { display: flex; align-items: center; gap: 6px; }

#search-input {
    padding: 5px 10px;
    background: #1a1a1a;
    border: 2px solid #3a3a3a;
    border-radius: 4px;
    color: #e0e0e0;
    font-size: 12px;
    width: 220px;
    outline: none;
    transition: border-color 0.2s;
}
#search-input:focus { border-color: #D4AF37; box-shadow: 0 0 0 3px rgba(212,175,55,0.1); }
#item-count { color: #a0a0a0; white-space: nowrap; margin-left: auto; font-size: 12px; }

/* Upload */
#upload-overlay {
    position: absolute; inset: 0;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
    z-index: 100;
}
#upload-overlay.hidden { display: none; }
#drop-zone {
    width: 500px; height: 240px;
    border: 2px dashed #4a4a4a; border-radius: 12px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    cursor: pointer; transition: all 0.3s; background: #151515;
}
#drop-zone:hover, #drop-zone.dragover { border-color: #D4AF37; background: #1a1a1a; }
#drop-zone h2 {
    font-size: 22px; margin-bottom: 8px;
    background: linear-gradient(135deg, #D4AF37, #B8860B);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}
#drop-zone p { font-size: 13px; color: #a0a0a0; }
#file-input { display: none; }
#upload-error { color: #ff6b6b; margin-top: 12px; font-size: 13px; }

/* Table */
#table-container {
    flex: 1;
    overflow: auto;
    padding: 0;
}

#item-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}

#item-table thead {
    position: sticky;
    top: 0;
    z-index: 5;
}

.planet-header-row th {
    background: #0e0e0e;
    padding: 5px 12px;
    text-align: center;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    border-bottom: 1px solid #3a3a3a;
}
.planet-header-row th.planet-group { border-left: 2px solid #3a3a3a; }
.planet-color-nauvis { color: #4caf50; }
.planet-color-vulcanus { color: #ff5722; }
.planet-color-fulgora { color: #9c27b0; }
.planet-color-gleba { color: #8bc34a; }
.planet-color-aquilo { color: #03a9f4; }

#item-table .col-header {
    background: #151515;
    padding: 6px 12px;
    text-align: left;
    color: #a0a0a0;
    font-weight: 600;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid #3a3a3a;
    cursor: pointer;
    user-select: none;
    white-space: nowrap;
    transition: color 0.15s;
}
#item-table .col-header:hover { color: #D4AF37; }
#item-table .col-header.sorted::after { content: ' \25BC'; color: #D4AF37; }
#item-table .col-header.sorted-asc::after { content: ' \25B2'; color: #D4AF37; }
#item-table .col-header.planet-start { border-left: 2px solid #3a3a3a; }

.item-row {
    cursor: pointer;
    transition: background 0.1s;
    border-bottom: 1px solid #1e1e1e;
}
.item-row:hover { background: #222; }
.item-row.expanded { background: #252525; }
.item-row.highlighted {
    animation: highlight-fade 2s ease-out forwards;
}
@keyframes highlight-fade {
    0% { background: rgba(212,175,55,0.25); }
    100% { background: transparent; }
}

.item-row td {
    padding: 5px 12px;
    vertical-align: middle;
}
.item-row td.planet-start { border-left: 2px solid #3a3a3a; }

.item-cell {
    display: flex;
    align-items: center;
    gap: 8px;
}
.item-cell img {
    width: 24px;
    height: 24px;
    image-rendering: pixelated;
    flex-shrink: 0;
}

.value-cell { color: #D4AF37; font-variant-numeric: tabular-nums; white-space: nowrap; }
.value-cell.empty { color: #2a2a2a; }

.source-badge {
    display: inline-block;
    padding: 1px 6px;
    border-radius: 3px;
    font-size: 10px;
    font-weight: 600;
}
.source-badge.raw { background: rgba(76,175,80,0.15); color: #4caf50; }
.source-badge.recipe { background: rgba(255,152,0,0.15); color: #ff9800; }
.source-badge.import { background: rgba(0,188,212,0.15); color: #00bcd4; }
.source-badge.unknown { background: rgba(136,136,136,0.15); color: #666; }

/* Detail row — column-aligned */
.detail-row { border-bottom: 1px solid #1e1e1e; }
.detail-row td {
    padding: 6px 12px 10px;
    vertical-align: top;
    background: #1a1a1a;
    border-top: 1px solid #2a2a2a;
    font-size: 12px;
}
.detail-row td.planet-start { border-left: 2px solid #3a3a3a; }
.detail-row td.detail-item-cell { padding-top: 8px; }

.detail-section {
    margin-bottom: 5px;
}
.detail-section:last-child { margin-bottom: 0; }
.detail-section-label {
    color: #666;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 2px;
}

.detail-items {
    display: flex;
    flex-direction: column;
    gap: 3px;
}

.detail-item {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 6px;
    background: #252525;
    border: 1px solid #3a3a3a;
    border-radius: 3px;
    cursor: pointer;
    transition: all 0.15s;
    font-size: 11px;
    width: fit-content;
    position: relative;
}
.detail-item:hover {
    background: #333;
    border-color: #D4AF37;
    color: #fff;
}
.detail-item[data-tooltip]:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: calc(100% + 4px);
    left: 50%;
    transform: translateX(-50%);
    background: #111;
    border: 1px solid #D4AF37;
    color: #e0e0e0;
    padding: 3px 8px;
    border-radius: 3px;
    font-size: 11px;
    white-space: nowrap;
    pointer-events: none;
    z-index: 100;
}
.detail-item img {
    width: 16px;
    height: 16px;
    image-rendering: pixelated;
}
.detail-item .amount { color: #a0a0a0; margin-left: 1px; }

.import-path {
    display: flex;
    align-items: center;
    gap: 4px;
    flex-wrap: wrap;
}
.import-planet {
    display: inline-flex;
    align-items: center;
    padding: 2px 7px;
    background: rgba(0,188,212,0.08);
    border: 1px solid rgba(0,188,212,0.25);
    border-radius: 3px;
    color: #00bcd4;
    font-size: 11px;
}
.import-arrow { color: #444; font-size: 12px; }

.recipe-name-label { color: #ff9800; font-weight: 600; font-size: 11px; margin-bottom: 3px; }
.raw-label { color: #4caf50; font-size: 11px; }
.empty-detail { color: #2a2a2a; }
</style>
</head>
<body>

<div id="upload-overlay">
    <div id="drop-zone">
        <h2>Hextorio Item Value Explorer (HIVE)</h2>
        <p>Drop your <code>all-item-values-encoded-json.txt</code> here</p>
        <p style="margin-top: 12px; font-size: 12px; color: #555;">or click to browse</p>
    </div>
    <div id="upload-error"></div>
    <input type="file" id="file-input" accept=".txt">
</div>

<div id="header" style="display: none;">
    <h1>Hextorio Item Value Explorer (HIVE)</h1>
</div>

<div id="toolbar" style="display: none;">
    <div class="toolbar-group">
        <input type="text" id="search-input" placeholder="Search items...">
    </div>
    <span id="item-count"></span>
</div>

<div id="table-container" style="display: none;">
    <table id="item-table">
        <thead id="table-head"></thead>
        <tbody id="table-body"></tbody>
    </table>
</div>

<script>
const ALL_PLANETS = ['nauvis', 'vulcanus', 'fulgora', 'gleba', 'aquilo'];
const PLANET_COLORS = {
    nauvis: '#4caf50', vulcanus: '#ff5722', fulgora: '#9c27b0',
    gleba: '#8bc34a', aquilo: '#03a9f4',
};

let exportData = null;
let activePlanets = [];
let expandedItem = null;
let sortKey = 'name';
let sortAsc = true;

function iconProxyUrl(name) {
    return `/icon?name=${encodeURIComponent(name)}`;
}

function decodeExport(base64String) {
    const cleaned = base64String.trim();
    const binaryString = atob(cleaned);
    const bytes = new Uint8Array(binaryString.length);
    for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
    return JSON.parse(pako.inflate(bytes, { to: 'string' }));
}

function formatValue(v) {
    if (v >= 1e6) return (v / 1e6).toFixed(2) + 'M';
    if (v >= 1e3) return (v / 1e3).toFixed(2) + 'K';
    if (v >= 1) return v.toFixed(2);
    if (v >= 0.01) return v.toFixed(3);
    return v.toExponential(2);
}

function formatName(name) {
    return name.replace(/-/g, ' ');
}

function formatAmount(a) {
    return Number.isInteger(a) ? a : a.toFixed(1);
}

// -- Build unified item list --

function getAllItems() {
    const search = document.getElementById('search-input').value.trim().toLowerCase();
    const itemMap = {};

    for (const planet of activePlanets) {
        const values = exportData.values[planet] || {};
        const sources = (exportData.sources || {})[planet] || {};
        for (const [name, value] of Object.entries(values)) {
            if (search && !name.includes(search)) continue;
            if (!itemMap[name]) itemMap[name] = { name, planets: {} };
            itemMap[name].planets[planet] = {
                value,
                source: sources[name] || { type: 'unknown' },
            };
        }
    }

    const items = Object.values(itemMap);
    sortItemList(items);
    return items;
}

function sortItemList(items) {
    const dir = sortAsc ? 1 : -1;

    if (sortKey === 'name') {
        items.sort((a, b) => dir * a.name.localeCompare(b.name));
        return;
    }

    const parts = sortKey.split('-');
    const field = parts.pop();
    const planet = parts.join('-');

    if (field === 'value') {
        items.sort((a, b) => {
            const va = a.planets[planet]?.value ?? -1;
            const vb = b.planets[planet]?.value ?? -1;
            return dir * (va - vb);
        });
    } else if (field === 'source') {
        const order = { raw: 0, recipe: 1, import: 2, unknown: 3 };
        items.sort((a, b) => {
            const sa = order[a.planets[planet]?.source?.type] ?? 4;
            const sb = order[b.planets[planet]?.source?.type] ?? 4;
            if (sa !== sb) return dir * (sa - sb);
            return -(( a.planets[planet]?.value ?? -1) - (b.planets[planet]?.value ?? -1));
        });
    }
}

// -- Table header --

function buildTableHead() {
    const thead = document.getElementById('table-head');

    let groupRow = '<tr class="planet-header-row"><th></th>';
    for (const planet of activePlanets) {
        groupRow += '<th colspan="2" class="planet-group planet-color-' + planet + '">' +
            planet.charAt(0).toUpperCase() + planet.slice(1) + '</th>';
    }
    groupRow += '</tr>';

    let colRow = '<tr>';
    const nameClass = sortKey === 'name' ? ' ' + (sortAsc ? 'sorted-asc' : 'sorted') : '';
    colRow += '<th class="col-header' + nameClass + '" data-sort="name">Item</th>';

    for (const planet of activePlanets) {
        const vKey = planet + '-value';
        const sKey = planet + '-source';
        const vClass = sortKey === vKey ? (sortAsc ? ' sorted-asc' : ' sorted') : '';
        const sClass = sortKey === sKey ? (sortAsc ? ' sorted-asc' : ' sorted') : '';
        colRow += '<th class="col-header planet-start' + vClass + '" data-sort="' + vKey + '">Value</th>';
        colRow += '<th class="col-header' + sClass + '" data-sort="' + sKey + '">Source</th>';
    }
    colRow += '</tr>';

    thead.innerHTML = groupRow + colRow;

    thead.querySelectorAll('.col-header').forEach(th => {
        th.addEventListener('click', () => {
            const key = th.dataset.sort;
            if (sortKey === key) {
                sortAsc = !sortAsc;
            } else {
                sortKey = key;
                sortAsc = key === 'name';
            }
            renderTable();
        });
    });
}

// -- Render --

function renderTable(highlightItem) {
    expandedItem = null;
    const items = getAllItems();
    document.getElementById('item-count').textContent = items.length + ' items';

    const tbody = document.getElementById('table-body');
    tbody.innerHTML = '';
    buildTableHead();

    for (const item of items) {
        const row = createItemRow(item);
        tbody.appendChild(row);
        if (highlightItem === item.name) row.classList.add('highlighted');
    }

    if (highlightItem) {
        const targetRow = tbody.querySelector(`[data-item="${highlightItem}"]`);
        if (targetRow) {
            setTimeout(() => targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' }), 50);
        }
    }
}

function createItemRow(item) {
    const row = document.createElement('tr');
    row.className = 'item-row';
    row.dataset.item = item.name;

    let html = '<td><div class="item-cell">' +
        '<img src="' + iconProxyUrl(item.name) + '" onerror="this.style.visibility=\'hidden\'">' +
        '<span>' + formatName(item.name) + '</span>' +
        '</div></td>';

    for (const planet of activePlanets) {
        const pd = item.planets[planet];
        if (pd) {
            const st = pd.source.type || 'unknown';
            html += '<td class="value-cell planet-start">' + formatValue(pd.value) + '</td>';
            html += '<td><span class="source-badge ' + st + '">' + st + '</span></td>';
        } else {
            html += '<td class="value-cell empty planet-start">&mdash;</td><td></td>';
        }
    }

    row.innerHTML = html;
    row.addEventListener('click', () => toggleExpand(item, row));
    return row;
}

// -- Expand / collapse (column-aligned) --

function toggleExpand(item, row) {
    const existing = document.querySelector('.detail-row');
    const wasExpanded = expandedItem === item.name;
    if (existing) existing.remove();
    document.querySelectorAll('.item-row.expanded').forEach(r => r.classList.remove('expanded'));
    expandedItem = null;

    if (wasExpanded) return;

    expandedItem = item.name;
    row.classList.add('expanded');

    const detailRow = document.createElement('tr');
    detailRow.className = 'detail-row';

    // Item name cell (first column): show "used in" aggregated across all planets? No — keep it per planet.
    // First cell is empty or shows the item name context.
    let html = '<td class="detail-item-cell"></td>';

    for (const planet of activePlanets) {
        const pd = item.planets[planet];
        // Each planet gets a merged cell spanning value + source columns
        if (!pd) {
            html += '<td colspan="2" class="planet-start empty-detail">&mdash;</td>';
            continue;
        }

        html += '<td colspan="2" class="planet-start detail-item-cell">' +
            buildPlanetDetailHtml(item.name, pd, planet) + '</td>';
    }

    detailRow.innerHTML = html;
    row.after(detailRow);

    // Wire clicks
    detailRow.querySelectorAll('.detail-item[data-item]').forEach(el => {
        el.addEventListener('click', (e) => {
            e.stopPropagation();
            navigateToItem(el.dataset.item);
        });
    });
}

function itemChip(name, planet, amount) {
    const values = (exportData.values || {})[planet] || {};
    const val = values[name];
    const tooltip = val != null ? formatValue(val) : '';
    return '<div class="detail-item" data-item="' + name + '"' +
        (tooltip ? ' data-tooltip="' + tooltip + '"' : '') + '>' +
        '<img src="' + iconProxyUrl(name) + '" onerror="this.style.visibility=\'hidden\'">' +
        formatName(name) +
        (amount != null ? '<span class="amount">x' + formatAmount(amount) + '</span>' : '') +
    '</div>';
}

function buildPlanetDetailHtml(itemName, pd, planet) {
    const recipes = exportData.recipes || {};
    const source = pd.source;
    let html = '';

    if (source.type === 'raw') {
        html += '<div class="raw-label">Raw resource</div>';
    } else if (source.type === 'recipe') {
        const recipe = recipes[source.recipe_name];
        html += '<div class="detail-section-label">Recipe</div>' +
            '<div class="recipe-name-label">' + formatName(source.recipe_name) + '</div>';

        if (recipe && recipe.ingredients) {
            html += '<div class="detail-section">' +
                '<div class="detail-section-label">Ingredients</div>' +
                '<div class="detail-items">' +
                recipe.ingredients.map(i => itemChip(i.name, planet, i.amount)).join('') +
                '</div></div>';
        }
        if (recipe && recipe.products && (recipe.products.length > 1 || recipe.products[0]?.name !== itemName)) {
            html += '<div class="detail-section">' +
                '<div class="detail-section-label">Products</div>' +
                '<div class="detail-items">' +
                recipe.products.filter(p => p.name !== itemName).map(p => itemChip(p.name, planet, p.amount)).join('') +
                '</div></div>';
        }
    } else if (source.type === 'import') {
        const path = source.import_path || [];
        const dist = source.distance ? ' (' + Math.round(source.distance).toLocaleString() + ' km)' : '';
        html += '<div class="detail-section">' +
            '<div class="detail-section-label">Import' + dist + '</div>' +
            '<div class="import-path">';
        for (let i = 0; i < path.length; i++) {
            if (i > 0) html += '<span class="import-arrow">\u2192</span>';
            html += '<span class="import-planet">' +
                path[i].charAt(0).toUpperCase() + path[i].slice(1) + '</span>';
        }
        html += '</div></div>';
    }

    // Used In
    html += buildUsedInHtml(itemName, planet);

    return html;
}

function findUsedIn(itemName, planet) {
    const sources = (exportData.sources || {})[planet] || {};
    const recipes = exportData.recipes || {};
    const results = [];
    const seen = new Set();

    for (const [, source] of Object.entries(sources)) {
        if (source.type !== 'recipe' || !source.recipe_name) continue;
        if (seen.has(source.recipe_name)) continue;
        const recipe = recipes[source.recipe_name];
        if (!recipe || !recipe.ingredients) continue;
        if (!recipe.ingredients.some(i => i.name === itemName)) continue;
        seen.add(source.recipe_name);
        results.push({ recipeName: source.recipe_name, products: recipe.products || [] });
    }

    results.sort((a, b) => a.recipeName.localeCompare(b.recipeName));
    return results;
}

function buildUsedInHtml(itemName, planet) {
    const usedIn = findUsedIn(itemName, planet);
    if (usedIn.length === 0) return '';

    const chips = [];
    const seen = new Set();
    for (const entry of usedIn) {
        for (const p of entry.products) {
            if (p.name === itemName || seen.has(p.name)) continue;
            seen.add(p.name);
            chips.push(itemChip(p.name, planet));
        }
    }

    if (chips.length === 0) return '';

    return '<div class="detail-section">' +
        '<div class="detail-section-label">Used In (' + chips.length + ')</div>' +
        '<div class="detail-items">' + chips.join('') + '</div>' +
    '</div>';
}

function navigateToItem(itemName) {
    let targetRow = document.querySelector(`tr.item-row[data-item="${itemName}"]`);
    if (!targetRow) {
        const searchInput = document.getElementById('search-input');
        if (searchInput.value) {
            searchInput.value = '';
            renderTable();
            targetRow = document.querySelector(`tr.item-row[data-item="${itemName}"]`);
        }
        if (!targetRow) return;
    }

    const existing = document.querySelector('.detail-row');
    if (existing) existing.remove();
    document.querySelectorAll('.item-row.expanded').forEach(r => r.classList.remove('expanded'));
    expandedItem = null;

    document.querySelectorAll('.item-row.highlighted').forEach(r => r.classList.remove('highlighted'));
    targetRow.classList.remove('highlighted');
    void targetRow.offsetWidth;
    targetRow.classList.add('highlighted');
    targetRow.addEventListener('animationend', () => targetRow.classList.remove('highlighted'), { once: true });
    targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// -- Search --

document.getElementById('search-input').addEventListener('input', () => renderTable());

// -- File upload --

function handleFile(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = decodeExport(e.target.result);
            exportData = data.version ? data : { version: 1, values: data, sources: {}, recipes: {} };
            activePlanets = ALL_PLANETS.filter(p => exportData.values[p]);

            document.getElementById('upload-overlay').classList.add('hidden');
            document.getElementById('header').style.display = 'flex';
            document.getElementById('toolbar').style.display = 'flex';
            document.getElementById('table-container').style.display = 'block';

            if (activePlanets.length > 0) {
                sortKey = activePlanets[0] + '-value';
                sortAsc = false;
            }
            renderTable();
        } catch (err) {
            document.getElementById('upload-error').textContent = 'Failed to decode: ' + err.message;
            console.error(err);
        }
    };
    reader.readAsText(file);
}

const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');
dropZone.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', (e) => { if (e.target.files[0]) handleFile(e.target.files[0]); });
dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
});
</script>
</body>
</html>
